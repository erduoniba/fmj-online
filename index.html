<!--
/**
 * ä¼é­”è®°(FMJ) æ¸¸æˆä¸»é¡µé¢
 * 
 * æ–‡ä»¶è¯´æ˜:
 * - è¿™æ˜¯æ¸¸æˆçš„ä¸»å…¥å£HTMLæ–‡ä»¶
 * - è´Ÿè´£åŠ è½½æ‰€æœ‰å¿…è¦çš„JavaScriptæ–‡ä»¶å’Œåˆå§‹åŒ–æ¸¸æˆç”»å¸ƒ
 * 
 * ä¸»è¦ç»„ä»¶:
 * 1. æ¸¸æˆç”»å¸ƒ (canvas#lcd)
 *    - å°ºå¯¸: 320x192 åƒç´ 
 *    - æ˜¾ç¤ºå°ºå¯¸: 640x384 åƒç´  (2å€ç¼©æ”¾)
 * 
 * 2. æŒ‰é”®æ˜ å°„è¯´æ˜
 *    - [ -> PageUp    (ä¸Šä¸€é¡µ/ä¸Šä¸€é€‰é¡¹)
 *    - ] -> PageDown  (ä¸‹ä¸€é¡µ/ä¸‹ä¸€é€‰é¡¹)
 *    - Space -> Esc   (è¿”å›/å–æ¶ˆ)
 *    - Enter -> ç¡®è®¤  (ç¡®è®¤/é€‰æ‹©)
 * 
 * ä¾èµ–æ–‡ä»¶:
 * 1. åŸºç¡€åº“:
 *    - jquery.min.js     : jQueryåº“
 *    - encoding.js       : å­—ç¬¦ç¼–ç æ”¯æŒ
 *    - encoding-indexes.js: å­—ç¬¦ç¼–ç ç´¢å¼•
 *    - sys.js           : ç³»ç»ŸåŠŸèƒ½æ”¯æŒ
 * 
 * 2. æ¸¸æˆæ ¸å¿ƒ:
 *    - rom.js           : æ¸¸æˆèµ„æº
 *    - kotlin.js        : Kotlinè¿è¡Œæ—¶
 *    - fmj.core.v2.js      : æ¸¸æˆä¸»ç¨‹åº
 */
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ä¼é­”è®°(FMJ) - Kotlin/JS ç‰ˆæœ¬</title>
    <script src="libs/js/jquery.min.js"></script>
    <script src="libs/js/encoding-indexes.js"></script>
    <script src="libs/js/encoding.js"></script>
    <script src="libs/js/sys.js"></script>
    <script src="libs/js/rom.js"></script>

    <style>
      body {
        background-color: #1a1a1a; /* æ·±è‰²èƒŒæ™¯è®©åƒç´ æ›´æ¸…æ™° */
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh; /* ä½¿ç”¨heightè€Œä¸æ˜¯min-height */
        padding: 10px; /* å‡å°‘padding */
        box-sizing: border-box;
        color: #fff;
        font-family: "Courier New", monospace;
        overflow: hidden; /* é˜²æ­¢æ•´ä½“é¡µé¢æ»šåŠ¨ */
      }
      .game-container {
        position: relative;
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        background: #000;
        padding: 10px; /* å‡å°‘padding */
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        flex: 1; /* è®©æ¸¸æˆå®¹å™¨å ç”¨å¯ç”¨ç©ºé—´ */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* é˜²æ­¢å®¹å™¨å†…æ»šåŠ¨ */
      }
      .lcd {
        position: relative;
        width: 100%;
        padding-top: 60%;
        background: #000;
        border: 2px solid #333;
        box-sizing: border-box;
        overflow: hidden;
        image-rendering: pixelated; /* æµè§ˆå™¨æ ‡å‡† */
        image-rendering: crisp-edges; /* å…¼å®¹æ”¯æŒ */
      }
      #lcd {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-edges;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        -ms-interpolation-mode: nearest-neighbor;
        transform: translateZ(0); /* å¯ç”¨GPUåŠ é€Ÿ */
        backface-visibility: hidden; /* é˜²æ­¢æ¨¡ç³Š */
        background: #fff;
      }
      .scale-controls {
        margin: 8px 0; /* å‡å°‘margin */
        text-align: center;
      }
      .scale-controls button {
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 16px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        font-family: "Courier New", monospace;
        transition: background 0.2s;
        outline: none;
      }
      .scale-controls button:hover {
        background: #444;
      }
      .scale-controls button.active {
        background: #666;
      }
      .game-controls {
        margin: 8px 0; /* å‡å°‘margin */
        text-align: center;
      }
      .game-controls button {
        background: #2a5934;
        color: #fff;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-size: 14px;
        transition: all 0.3s;
        outline: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .game-controls button:hover {
        background: #3a6f44;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      }
      .game-controls button:active {
        background: #1e4028;
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .game-controls button:disabled {
        background: #555;
        color: #888;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .controls {
        margin-top: 20px;
        text-align: center;
        background: #333;
        padding: 15px;
        border-radius: 4px;
        line-height: 1.6;
      }
      @media (min-resolution: 2dppx) {
        #lcd {
          transform: translateZ(0) scale(1.01); /* ä¿®å¤Retinaå±å¹•ä¸Šçš„æ¸²æŸ“é—®é¢˜ */
        }
      }
      
      /* ç©å®¶ä½ç½®é—ªçƒåŠ¨ç”» */
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
      }
      
      #player-dot {
        animation: blink 1s infinite;
      }
      
      .treasure-box {
        transition: opacity 0.2s ease;
      }
      
      .treasure-box:hover {
        opacity: 0.8;
        z-index: 30 !important;
      }
      
      /* åœ°å›¾è°ƒè¯•åŒºåŸŸå“åº”å¼è®¾è®¡ */
      #map-debug {
        max-width: 100%;
        box-sizing: border-box;
        margin-top: 10px; /* å‡å°‘é¡¶éƒ¨é—´è· */
        padding: 10px; /* å‡å°‘padding */
        flex-shrink: 0; /* é˜²æ­¢æ”¶ç¼© */
      }
      
      #map-container {
        width: 100%;
        max-width: 800px; /* æœ€å¤§å®½åº¦é™åˆ¶ */
        margin: 5px auto; /* å‡å°‘margin */
      }
      
      #map-preview {
        min-width: 200px; /* æœ€å°å®½åº¦ */
        max-height: 40vh; /* å‡å°‘æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„40% */
        object-fit: contain; /* ä¿æŒå®½é«˜æ¯” */
      }
      
      /* å“åº”å¼å¸ƒå±€ */
      @media (max-width: 768px) {
        body {
          padding: 5px; /* å°å±å¹•æ›´å°‘padding */
        }
        
        .game-container {
          padding: 5px; /* å°å±å¹•æ›´å°‘padding */
        }
        
        #map-container {
          max-width: 100%;
          padding: 5px;
        }
        
        #map-preview {
          max-height: 30vh; /* å°å±å¹•æ›´å°é«˜åº¦ */
        }
        
        #map-debug {
          padding: 5px;
          margin-top: 5px;
        }
      }
      
      @media (min-width: 1200px) {
        #map-container {
          max-width: 1000px;
        }
        
        #map-preview {
          max-height: 45vh; /* å¤§å±å¹•é€‚ä¸­é«˜åº¦ */
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="lcd">
        <canvas id="lcd" width="320" height="192"></canvas>
      </div>
      <div class="scale-controls">
        <button onclick="setScale(2)" data-scale="2">2x</button>
        <button onclick="setScale(4)" data-scale="4">4x</button>
        <button onclick="setScale(6)" data-scale="6">6x</button>
        <button onclick="setScale(8)" data-scale="8">8x</button>
        <button onclick="toggleFullscreen()">å…¨å±</button>
      </div>
      
      <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
      <div class="game-controls">
        <button onclick="repeatLastAction()" id="repeatBtn" title="é‡å¤ä¸Šæ¬¡æˆ˜æ–—åŠ¨ä½œ (Ré”®)">ğŸ”„ é‡å¤åŠ¨ä½œ</button>
      </div>
      
    
    <!-- åœ°å›¾è°ƒè¯•åŒºåŸŸ -->
    <div id="map-debug" style="margin-top: 10px; background: #333; padding: 5px; border-radius: 4px; color: #fff; font-family: 'Courier New', monospace; display: none;">
      <div id="map-container" style="background: #000; padding: 10px; border-radius: 4px; margin: 10px 0; position: relative;">
        <img id="map-preview" src="" alt="åœ°å›¾é¢„è§ˆ" style="width: 100%; max-width: 100%; height: auto; border: 1px solid #666; image-rendering: pixelated; display: block;" />
        <div id="player-dot" style="position: absolute; background: red; border-radius: 50%; display: none; z-index: 10; box-shadow: 0 0 4px rgba(255,0,0,0.8);"></div>
      </div>
      <textarea id="map-base64" readonly style="width: 100%; height: 100px; background: #222; color: #ccc; border: 1px solid #555; padding: 5px; font-family: 'Courier New', monospace; resize: vertical;"></textarea>
      <button onclick="toggleMapDebug()" style="margin-top: 10px; background: #666; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">éšè—åœ°å›¾è°ƒè¯•</button>
    </div>

    <!-- <div class="controls">
      æŒ‰é”®æ˜ å°„<br />
      [ -> PageUp<br />
      ] -> PageDown<br />
      Space -> Esc<br />
      Enter -> è¾“å…¥<br />
    </div> -->
  </div>

    <script src="out/production/fmj.core/kotlin.js"></script>
    <script src="out/production/fmj.core/fmj.core.v2.js"></script>
    <script>
      // ç¼©æ”¾æ§åˆ¶
      function setScale(scale) {
        const container = document.querySelector(".game-container");
        container.style.maxWidth = 320 * scale + "px";

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll(".scale-controls button").forEach((btn) => {
          if (btn.dataset.scale === scale.toString()) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });

        // åº”ç”¨æœ€ä½³æ¸²æŸ“è®¾ç½®
        const canvas = document.getElementById("lcd");
        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = false;

        // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿æ¸…æ™°åº¦
        canvas.style.display = "none";
        canvas.offsetHeight; // è§¦å‘é‡æ’
        canvas.style.display = "";
      }

      // å…¨å±æ§åˆ¶
      function toggleFullscreen() {
        const container = document.querySelector(".game-container");
        if (!document.fullscreenElement) {
          container
            .requestFullscreen()
            .then(() => {
              // å…¨å±åè‡ªåŠ¨è°ƒæ•´åˆ°æœ€ä½³ç¼©æ”¾æ¯”ä¾‹
              setTimeout(setInitialScale, 100);
            })
            .catch((err) => {
              console.log(`å…¨å±é”™è¯¯: ${err.message}`);
            });
        } else {
          document.exitFullscreen().then(() => {
            // é€€å‡ºå…¨å±åæ¢å¤ä¹‹å‰çš„ç¼©æ”¾æ¯”ä¾‹
            setTimeout(setInitialScale, 100);
          });
        }
      }

      // è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„åˆå§‹ç¼©æ”¾æ¯”ä¾‹
      function setInitialScale() {
        const width = window.innerWidth - 80; // è€ƒè™‘padding
        const height = window.innerHeight - 200; // è€ƒè™‘å…¶ä»–UIå…ƒç´ 
        const baseWidth = 320;
        const baseHeight = 192;

        // è®¡ç®—æœ€å¤§å¯èƒ½çš„ç¼©æ”¾æ¯”ä¾‹
        const scaleX = Math.floor(width / baseWidth);
        const scaleY = Math.floor(height / baseHeight);
        let scale = Math.min(scaleX, scaleY, 8); // æœ€å¤§8å€ç¼©æ”¾
        scale = Math.max(2, scale); // æœ€å°2å€ç¼©æ”¾

        // ä¼˜å…ˆé€‰æ‹©å¶æ•°å€ç¼©æ”¾
        if (scale % 2 !== 0 && scale > 2) {
          scale = scale - 1;
        }

        setScale(scale);
      }

      // åœ°å›¾è°ƒè¯•åŠŸèƒ½
      function showMapBase64(base64Data) {
        const mapDebug = document.getElementById('map-debug');
        const mapPreview = document.getElementById('map-preview');
        const mapBase64 = document.getElementById('map-base64');
        
        if (base64Data) {
          const dataUrl = 'data:image/png;base64,' + base64Data;
          mapPreview.src = dataUrl;
          mapBase64.value = base64Data;
          mapDebug.style.display = 'block';
          
          // å½“åœ°å›¾å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°è®¡ç®—ç©å®¶ä½ç½®
          mapPreview.onload = function() {
            setTimeout(recalculatePlayerPosition, 100);
          };
        }
      }

      function toggleMapDebug() {
        const mapDebug = document.getElementById('map-debug');
        mapDebug.style.display = mapDebug.style.display === 'none' ? 'block' : 'none';
      }

      // å­˜å‚¨å½“å‰ç©å®¶ä½ç½®æ•°æ®ï¼Œç”¨äºçª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
      let currentPlayerPosition = null;
      
      // å­˜å‚¨å½“å‰å®ç®±ä½ç½®æ•°æ®ï¼Œç”¨äºçª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
      let currentTreasureBoxes = null;
      
      // æ›´æ–°ç©å®¶ä½ç½®çš„é—ªçƒç‚¹
      function updatePlayerPosition(relativeX, relativeY, mapX, mapY, mapWidth, mapHeight) {
        // ä¿å­˜å½“å‰ä½ç½®æ•°æ®
        currentPlayerPosition = { relativeX, relativeY, mapX, mapY, mapWidth, mapHeight };
        
        const mapPreview = document.getElementById('map-preview');
        const playerDot = document.getElementById('player-dot');
        const mapContainer = document.getElementById('map-container');
        
        if (!mapPreview || !playerDot || !mapContainer) return;
        
        // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
        if (mapPreview.naturalWidth === 0) {
          mapPreview.onload = function() {
            positionPlayerDot();
          };
          return;
        }
        
        positionPlayerDot();
        
        function positionPlayerDot() {
          // è·å–å›¾ç‰‡çš„å®é™…æ˜¾ç¤ºå°ºå¯¸
          const imgRect = mapPreview.getBoundingClientRect();
          const containerRect = mapContainer.getBoundingClientRect();
          
          // è®¡ç®—ä¸€ä¸ªtileåœ¨å½“å‰æ˜¾ç¤ºå°ºå¯¸ä¸‹çš„å¤§å°
          // æ¯ä¸ªtileåœ¨åŸå§‹åœ°å›¾ä¸­æ˜¯16x16åƒç´ 
          const tileDisplayWidth = imgRect.width / mapWidth;
          const tileDisplayHeight = imgRect.height / mapHeight;
          
          // ç‚¹çš„å¤§å°åº”è¯¥æ˜¯ä¸€ä¸ªtileçš„å¤§å°ï¼Œä½†ä¸å°äº4pxï¼Œä¸å¤§äº20px
          const dotSize = Math.max(4, Math.min(20, Math.min(tileDisplayWidth, tileDisplayHeight)));
          
          // è®¡ç®—ç©å®¶åœ¨å›¾ç‰‡ä¸Šçš„åƒç´ ä½ç½®
          const dotX = relativeX * imgRect.width + tileDisplayWidth / 2;
          const dotY = relativeY * imgRect.height + tileDisplayHeight / 2;
          
          // ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
          const imgOffsetX = mapPreview.offsetLeft;
          const imgOffsetY = mapPreview.offsetTop;
          
          // æ›´æ–°ç‚¹çš„å¤§å°å’Œä½ç½®
          const halfDotSize = dotSize / 2;
          playerDot.style.width = dotSize + 'px';
          playerDot.style.height = dotSize + 'px';
          playerDot.style.left = (imgOffsetX + dotX - halfDotSize) + 'px';
          playerDot.style.top = (imgOffsetY + dotY - halfDotSize) + 'px';
          playerDot.style.display = 'block';
          
          console.log('Player position updated:', {
            mapPos: [mapX, mapY],
            mapSize: [mapWidth, mapHeight],
            relative: [relativeX, relativeY],
            pixel: [dotX, dotY],
            imgSize: [imgRect.width, imgRect.height],
            tileSize: [tileDisplayWidth, tileDisplayHeight],
            dotSize: dotSize,
            offset: [imgOffsetX, imgOffsetY]
          });
        }
      }
      
      // æ›´æ–°å®ç®±ä½ç½®ä¿¡æ¯
      function updateTreasureBoxes(treasureBoxes, mapWidth, mapHeight) {
        // ä¿å­˜å½“å‰å®ç®±æ•°æ®
        currentTreasureBoxes = { treasureBoxes, mapWidth, mapHeight };
        
        const mapContainer = document.getElementById('map-container');
        const mapPreview = document.getElementById('map-preview');
        
        if (!mapContainer || !mapPreview) return;
        
        // ç§»é™¤ç°æœ‰çš„æ‰€æœ‰å®ç®±ç‚¹
        const existingBoxes = mapContainer.querySelectorAll('.treasure-box');
        existingBoxes.forEach(box => box.remove());
        
        // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
        if (mapPreview.naturalWidth === 0) {
          mapPreview.onload = function() {
            positionTreasureBoxes();
          };
          return;
        }
        
        positionTreasureBoxes();
        
        function positionTreasureBoxes() {
          // è·å–å›¾ç‰‡çš„å®é™…æ˜¾ç¤ºå°ºå¯¸
          const imgRect = mapPreview.getBoundingClientRect();
          const containerRect = mapContainer.getBoundingClientRect();
          
          // è®¡ç®—ä¸€ä¸ªtileåœ¨å½“å‰æ˜¾ç¤ºå°ºå¯¸ä¸‹çš„å¤§å°
          const tileDisplayWidth = imgRect.width / mapWidth;
          const tileDisplayHeight = imgRect.height / mapHeight;
          
          // ä¸ºæ¯ä¸ªå®ç®±åˆ›å»ºæ ‡è®°ç‚¹
          treasureBoxes.forEach((box, index) => {
            const boxElement = document.createElement('div');
            boxElement.className = 'treasure-box';
            boxElement.dataset.boxIndex = index;
            boxElement.dataset.boxName = box.name;
            boxElement.dataset.isCollected = box.isCollected;
            
            // è®¡ç®—å®ç®±åœ¨åœ°å›¾ä¸­çš„ç›¸å¯¹ä½ç½®
            const relativeX = box.x / mapWidth;
            const relativeY = box.y / mapHeight;
            
            // è®¡ç®—å®ç®±åœ¨å›¾ç‰‡ä¸Šçš„åƒç´ ä½ç½®
            const boxX = relativeX * imgRect.width + tileDisplayWidth / 2;
            const boxY = relativeY * imgRect.height + tileDisplayWidth / 2;
            
            // ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
            const imgOffsetX = mapPreview.offsetLeft;
            const imgOffsetY = mapPreview.offsetTop;
            
            // å®ç®±ç‚¹çš„å¤§å°åº”è¯¥ç•¥å°äºtileå¤§å°ï¼Œä½†ä¸å°äº3pxï¼Œä¸å¤§äº8pxï¼ˆç¼©å°åˆ°ä¸€åŠï¼‰
            const boxSize = Math.max(3, Math.min(8, Math.min(tileDisplayWidth, tileDisplayHeight) * 0.4));
            const halfBoxSize = boxSize / 2;
            
            // è®¾ç½®å®ç®±æ ·å¼å’Œä½ç½®
            boxElement.style.width = boxSize + 'px';
            boxElement.style.height = boxSize + 'px';
            boxElement.style.left = (imgOffsetX + boxX - halfBoxSize) + 'px';
            boxElement.style.top = (imgOffsetY + boxY - halfBoxSize) + 'px';
            boxElement.style.position = 'absolute';
            boxElement.style.borderRadius = '2px';
            boxElement.style.border = '1px solid #000';
            boxElement.style.zIndex = '20';
            boxElement.style.cursor = 'pointer';
            
            // æ ¹æ®å®ç®±çŠ¶æ€è®¾ç½®é¢œè‰²
            if (box.isCollected) {
              boxElement.style.backgroundColor = '#888'; // ç°è‰² - å·²æ”¶é›†
              boxElement.style.boxShadow = '0 0 2px rgba(136,136,136,0.8)';
              boxElement.title = `å®ç®±: ${box.name} (å·²æ”¶é›†)`;
            } else {
              boxElement.style.backgroundColor = '#00f'; // è“è‰² - æœªæ”¶é›†
              boxElement.style.boxShadow = '0 0 4px rgba(0,0,255,0.8)';
              boxElement.title = `å®ç®±: ${box.name} (æœªæ”¶é›†)`;
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
            boxElement.addEventListener('click', function() {
              console.log(`ç‚¹å‡»äº†å®ç®±: ${box.name} at (${box.x}, ${box.y}), å·²æ”¶é›†: ${box.isCollected}`);
            });
            
            mapContainer.appendChild(boxElement);
          });
          
          console.log('Treasure boxes updated:', {
            count: treasureBoxes.length,
            mapSize: [mapWidth, mapHeight],
            imgSize: [imgRect.width, imgRect.height],
            tileSize: [tileDisplayWidth, tileDisplayHeight]
          });
        }
      }
      
      // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—ç©å®¶ä½ç½®å’Œå®ç®±ä½ç½®
      function recalculatePlayerPosition() {
        if (currentPlayerPosition) {
          updatePlayerPosition(
            currentPlayerPosition.relativeX,
            currentPlayerPosition.relativeY,
            currentPlayerPosition.mapX,
            currentPlayerPosition.mapY,
            currentPlayerPosition.mapWidth,
            currentPlayerPosition.mapHeight
          );
        }
        
        // åŒæ—¶é‡æ–°è®¡ç®—å®ç®±ä½ç½®
        if (currentTreasureBoxes) {
          updateTreasureBoxes(
            currentTreasureBoxes.treasureBoxes,
            currentTreasureBoxes.mapWidth,
            currentTreasureBoxes.mapHeight
          );
        }
      }

      // é‡å¤ä¸Šæ¬¡åŠ¨ä½œåŠŸèƒ½
      function repeatLastAction() {
        try {
          // æ–¹æ³•1: ç›´æ¥è°ƒç”¨æ¸¸æˆçš„é”®ç›˜å¤„ç†
          const core = window["fmj.core"];
          if (core && core.fmj && core.fmj.combat.Combat.Companion.IsActive()) {
            // ç›´æ¥å‘é€KEY_REPEAT(9)åˆ°æ¸¸æˆ
            core.fmj.combat.Combat.Companion.KeyDown(9);
          } else {
            // æ–¹æ³•2: å¦‚æœæˆ˜æ–—ä¸æ´»è·ƒï¼Œå°è¯•è§¦å‘é”®ç›˜äº‹ä»¶
            const event = jQuery.Event('keydown', {
              keyCode: 82,  // Ré”®çš„keyCode
              which: 82
            });
            $('body').trigger(event);
          }
        } catch (e) {
          console.log('é‡å¤åŠ¨ä½œå¤±è´¥:', e);
          // æ–¹æ³•3: å¤‡é€‰æ–¹æ¡ˆï¼Œç›´æ¥æ¨¡æ‹Ÿé”®ç›˜äº‹ä»¶
          const event = jQuery.Event('keydown', {
            keyCode: 82,  // Ré”®çš„keyCode
            which: 82
          });
          $('body').trigger(event);
        }
        
        // æ·»åŠ è§†è§‰åé¦ˆ
        const btn = document.getElementById('repeatBtn');
        if (btn) {
          btn.style.background = '#1e4028';
          setTimeout(() => {
            btn.style.background = '#2a5934';
          }, 150);
        }
      }

      // æ£€æŸ¥æ¸¸æˆçŠ¶æ€å¹¶æ›´æ–°æŒ‰é’®å¯ç”¨æ€§
      function updateGameControlButtons() {
        const repeatBtn = document.getElementById('repeatBtn');
        if (repeatBtn) {
          // è¿™é‡Œå¯ä»¥æ ¹æ®æ¸¸æˆçŠ¶æ€æ¥å¯ç”¨/ç¦ç”¨æŒ‰é’®
          // ä¾‹å¦‚ï¼šåªåœ¨æˆ˜æ–—çŠ¶æ€ä¸‹å¯ç”¨
          try {
            const core = window["fmj.core"];
            const isCombatActive = core && core.fmj.combat.Combat.Companion.IsActive();
            repeatBtn.disabled = !isCombatActive;
            repeatBtn.title = isCombatActive 
              ? "é‡å¤ä¸Šæ¬¡æˆ˜æ–—åŠ¨ä½œ (Ré”®)" 
              : "åªåœ¨æˆ˜æ–—ä¸­å¯ç”¨";
          } catch (e) {
            // å¦‚æœæ¸¸æˆè¿˜æ²¡åŠ è½½å®Œæˆï¼Œä¿æŒæŒ‰é’®å¯ç”¨
            repeatBtn.disabled = false;
          }
        }
      }

      // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›Kotlinè°ƒç”¨
      window.showMapBase64 = showMapBase64;
      window.updatePlayerPosition = updatePlayerPosition;
      window.updateTreasureBoxes = updateTreasureBoxes;
      window.repeatLastAction = repeatLastAction;
      window.updateGameControlButtons = updateGameControlButtons;
      
      // æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºåœ°å›¾å®¹å™¨ä¸­çš„ç‰©å“å’Œå…³é”®ç‚¹ï¼Œé»˜è®¤ä¸º ture
      window.mapContainerState = window.mapContainerState || true;

      // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
      window.onload = function () {
        // è®¾ç½®åˆå§‹ç¼©æ”¾
        setInitialScale();

        // è®¾ç½®Canvasæ¸²æŸ“ä¸Šä¸‹æ–‡
        const canvas = document.getElementById("lcd");
        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = false;

        // ä½¿ç”¨å…¨å±€å˜é‡è®¿é—®æ¨¡å—
        var core = window["fmj.core"].fmj;
        if (!core) {
          console.error("fmj.core module not found!");
          return;
        }
        console.log("Module loaded:", core);

        // æ¸¸æˆé€Ÿåº¦ï¼Œé»˜è®¤æ˜¯1å€é€Ÿ
        window.gameSpeedMultiple = setGameSpeedMultiple;
        function setGameSpeedMultiple(multiple) {
          let game = window.fmjGame;
          if (game && typeof game.listenUIEvents_14dthe$ === 'function') {
            game.listenUIEvents_14dthe$(multiple);
            return true;
          }
          return false;
        }

        // å¯åŠ¨æŒ‰é’®çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        setInterval(updateGameControlButtons, 500); // æ¯500msæ›´æ–°ä¸€æ¬¡
      };

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      let resizeTimeout;
      let mapResizeTimeout;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        clearTimeout(mapResizeTimeout);
        
        // æ¸¸æˆç¼©æ”¾è°ƒæ•´
        resizeTimeout = setTimeout(setInitialScale, 250);
        
        // åœ°å›¾é¢„è§ˆå’Œç©å®¶ä½ç½®è°ƒæ•´
        mapResizeTimeout = setTimeout(function() {
          recalculatePlayerPosition();
        }, 300);
      });

      // ç›‘å¬å…¨å±å˜åŒ–
      document.addEventListener("fullscreenchange", function () {
        setTimeout(setInitialScale, 100);
        setTimeout(recalculatePlayerPosition, 200);
      });
    </script>
  </body>
</html>
